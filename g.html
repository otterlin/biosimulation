<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¤ç‰©å‘åœ°æ€§èˆ‡é‡åŠ›æ¨¡æ“¬ (Gravitropism Simulation)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; background-color: #f0fdf4; font-family: 'Noto Sans TC', sans-serif; }
        canvas { display: block; }
        .panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .no-select { user-select: none; -webkit-user-select: none; }
        .chat-scroll::-webkit-scrollbar { width: 4px; }
        .chat-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .chat-scroll::-webkit-scrollbar-thumb { background: #16a34a; border-radius: 2px; }
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        
        /* Custom Slider */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #16a34a;
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #ddd;
            border-radius: 2px;
        }
    </style>
</head>
<body class="no-select text-slate-700">

    <!-- å·¦å´ï¼šæ§åˆ¶é¢æ¿ -->
    <div class="fixed top-4 left-4 p-5 panel w-80 z-10 transition-opacity hover:opacity-100 opacity-95 max-h-[90vh] overflow-y-auto">
        <h1 class="text-xl font-bold text-green-800 mb-1">é‡åŠ›èˆ‡å‘åœ°æ€§æ¨¡æ“¬</h1>
        <p class="text-xs text-gray-500 mb-4 border-b pb-2">é™¤å»å…‰æºå¹²æ“¾ï¼Œå–®ç´”è§€å¯Ÿé‡åŠ›å°ç”Ÿé•·ç´ åˆ†ä½ˆçš„å½±éŸ¿ã€‚</p>
        
        <!-- æ§åˆ¶é … -->
        <div class="space-y-4 mb-4">
            
            <!-- 1. åˆå§‹è§’åº¦ -->
            <div>
                <label class="flex justify-between text-sm font-bold text-gray-700 mb-1">
                    <span>ğŸ”„ åˆå§‹æ“ºæ”¾è§’åº¦</span>
                    <span id="angle-val" class="text-green-600">0Â° (æ°´å¹³)</span>
                </label>
                <input type="range" id="angle-slider" min="-90" max="90" value="0" step="15" 
                       oninput="updateAngleLabel(this.value)" onchange="resetPlantWithSettings()">
                <div class="flex justify-between text-[10px] text-gray-400 mt-1">
                    <span>-90Â°(ç›´ç«‹)</span>
                    <span>0Â°(æ©«æ”¾)</span>
                    <span>90Â°(å€’ç«‹)</span>
                </div>
            </div>

            <!-- 2. é‡åŠ›å½±éŸ¿åŠ› -->
            <div>
                <label class="flex justify-between text-sm font-bold text-gray-700 mb-1">
                    <span>ğŸŒ é‡åŠ›/ç”Ÿé•·ç´ æ•æ„Ÿåº¦</span>
                    <span id="gravity-val" class="text-blue-600">æ­£å¸¸</span>
                </label>
                <input type="range" id="gravity-slider" min="0" max="100" value="50" 
                       oninput="updateGravityLabel(this.value)">
                <div class="text-[10px] text-gray-400 mt-1">
                    èª¿ä½å¯æ¨¡æ“¬ç„¡é‡åŠ›(å¤ªç©º)ç’°å¢ƒï¼Œèª¿é«˜å‰‡åæ‡‰åŠ‡çƒˆã€‚
                </div>
            </div>

        </div>

        <!-- ç‹€æ…‹é¡¯ç¤º -->
        <div class="space-y-3 text-sm border-t pt-3">
            <!-- è–çš„é‚è¼¯ -->
            <div class="bg-green-50 p-2 rounded border border-green-200">
                <div class="font-bold text-green-800 mb-1 flex items-center gap-1">
                    ğŸŒ± è– (Stem)
                    <span class="text-[10px] bg-white px-1 rounded border text-green-600">èƒŒåœ°æ€§</span>
                </div>
                <div class="text-xs space-y-1">
                    <p>é‡åŠ›å°è‡´ç”Ÿé•·ç´ æ²‰ç©æ–¼ï¼š<span class="font-bold">ä¸‹æ–¹</span></p>
                    <p>è–éƒ¨å°ç”Ÿé•·ç´ åæ‡‰ï¼š<span class="font-bold text-red-500">æ¿ƒåº¦é«˜â”é•·å¾—å¿«</span></p>
                    <p class="border-t border-green-200 pt-1 mt-1 text-green-700">
                        çµæœï¼šä¸‹æ–¹é•·å¾—å¿«ï¼Œæ¤ç‰©<span class="font-bold">å‘ä¸Šå½æ›²</span>ã€‚
                    </p>
                </div>
            </div>

            <!-- æ ¹çš„é‚è¼¯ -->
            <div class="bg-amber-50 p-2 rounded border border-amber-200">
                <div class="font-bold text-amber-800 mb-1 flex items-center gap-1">
                    ğŸŸ¤ æ ¹ (Root)
                    <span class="text-[10px] bg-white px-1 rounded border text-amber-600">å‘åœ°æ€§</span>
                </div>
                <div class="text-xs space-y-1">
                    <p>é‡åŠ›å°è‡´ç”Ÿé•·ç´ æ²‰ç©æ–¼ï¼š<span class="font-bold">ä¸‹æ–¹</span></p>
                    <p>æ ¹éƒ¨å°ç”Ÿé•·ç´ åæ‡‰ï¼š<span class="font-bold text-blue-600">æ¿ƒåº¦é«˜â”é•·å¾—æ…¢</span></p>
                    <p class="border-t border-amber-200 pt-1 mt-1 text-amber-800">
                        çµæœï¼šä¸‹æ–¹é•·å¾—æ…¢ï¼Œæ¤ç‰©<span class="font-bold">å‘ä¸‹å½æ›²</span>ã€‚
                    </p>
                </div>
            </div>
        </div>

        <div class="mt-4 space-y-2">
            <button onclick="resetPlantWithSettings()" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded transition text-xs flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                å¥—ç”¨è¨­å®šä¸¦é‡ç½®
            </button>
            <button onclick="togglePause()" id="pause-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition text-xs">æš«åœ / ç¹¼çºŒ</button>
        </div>
    </div>

    <!-- å³å´ï¼šAI æ¤ç‰©å­¸å®¶é¢æ¿ -->
    <div class="fixed bottom-4 right-4 w-80 panel z-20 flex flex-col transition-all duration-300 transform translate-y-0" id="ai-panel">
        <div class="p-3 bg-green-100 rounded-t-xl border-b border-green-200 flex justify-between items-center cursor-pointer" onclick="toggleAiMinimize()">
            <h2 class="font-bold text-green-800 flex items-center gap-2">
                <span>ğŸ§¬ AI ç”Ÿç‰©è€å¸«</span>
            </h2>
            <button class="text-green-600 font-bold text-xl leading-none" id="minimize-icon">âˆ’</button>
        </div>
        
        <div id="ai-content-area" class="flex flex-col flex-1 p-3 gap-3">
            <div id="chat-history" class="flex-1 overflow-y-auto min-h-[150px] max-h-[300px] bg-white/60 rounded p-2 border border-green-100 text-sm space-y-2 chat-scroll">
                <div class="bg-green-50 text-green-900 p-2 rounded-lg rounded-tl-none inline-block max-w-[90%] text-xs">
                    å—¨ï¼é€™è£¡æ²’æœ‰é™½å…‰ï¼Œåªæœ‰<b>é‡åŠ›</b>ã€‚è©¦è‘—èª¿æ•´ã€Œåˆå§‹è§’åº¦ã€è®“æ¤ç‰©æ©«è‘—æ”¾ï¼Œæˆ–æ˜¯èª¿æ•´ã€Œé‡åŠ›æ•æ„Ÿåº¦ã€çœ‹çœ‹å¦‚æœæˆ‘å€‘åœ¨å¤ªç©ºä¸­ï¼ˆé‡åŠ›=0ï¼‰ï¼Œæ¤ç‰©æœƒæ€éº¼é•·ï¼Ÿ
                </div>
            </div>

            <button onclick="analyzeGrowth()" id="analyze-btn" class="w-full bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white font-bold py-2 px-3 rounded shadow-sm text-xs flex items-center justify-center gap-1 transition-all">
                âœ¨ åˆ†æç›®å‰çš„é‡åŠ›åæ‡‰
            </button>

            <div class="flex gap-2 border-t pt-2 border-green-100">
                <input type="text" id="user-input" placeholder="å•å•é—œæ–¼æ¾±ç²‰é«”æˆ–é‡åŠ›çš„å•é¡Œ..." 
                       class="flex-1 text-xs p-2 rounded border border-green-200 focus:outline-none focus:border-green-400 focus:ring-1 focus:ring-green-400 bg-white/80"
                       onkeypress="if(event.key === 'Enter') askGemini()">
                <button onclick="askGemini()" class="bg-green-600 hover:bg-green-700 text-white px-3 rounded transition flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <canvas id="simCanvas"></canvas>

<script>
/**
 * æ¤ç‰©é‡åŠ›æ¨¡æ“¬æ ¸å¿ƒ
 * å»é™¤å…‰æºï¼Œå°ˆæ³¨æ–¼é‡åŠ›å‘é‡èˆ‡è§’åº¦è¨ˆç®—
 */

const canvas = document.getElementById('simCanvas');
const ctx = canvas.getContext('2d');

// --- ç‹€æ…‹è®Šæ•¸ ---
let width, height;
let isPaused = false;
let animationId;

// ç‰©ç†èˆ‡æ¨¡æ“¬åƒæ•¸
const GROWTH_SPEED = 4; 
let frameCount = 0;
let gravityFactor = 0.5; // 0 ~ 1

// æ¤ç‰©è³‡æ–™çµæ§‹
let stemSegments = [];
let rootSegments = [];
let plantOrigin = { x: 0, y: 0 };
let initialAngleDeg = 0; // 0 = æ©«æ”¾ (Horizontal)

// Gemini API Configuration
const apiKey = ""; 
const apiModel = "gemini-2.5-flash-preview-09-2025"; 
let isAiPanelMinimized = false;

function init() {
    resize();
    resetPlantWithSettings();
    window.addEventListener('resize', resize);
    loop();
}

function resize() {
    width = window.innerWidth;
    height = window.innerHeight;
    canvas.width = width;
    canvas.height = height;
    
    // å¦‚æœæ²’æœ‰æ¤ç‰©ï¼Œæˆ–æ˜¯é‡ç½®æ™‚æ©Ÿ
    if (stemSegments.length === 0) {
        plantOrigin = { x: width / 2, y: height / 2 };
        resetPlantWithSettings();
    } else {
        plantOrigin = { x: width / 2, y: height / 2 };
    }
}

function updateAngleLabel(val) {
    document.getElementById('angle-val').innerText = `${val}Â°`;
    initialAngleDeg = parseInt(val);
}

function updateGravityLabel(val) {
    let text = "æ­£å¸¸";
    if (val == 0) text = "ç„¡é‡åŠ› (å¤ªç©º)";
    else if (val < 30) text = "å¾®é‡åŠ›";
    else if (val > 80) text = "è¶…é‡åŠ›/é«˜æ•æ„Ÿ";
    
    document.getElementById('gravity-val').innerText = text;
    gravityFactor = val / 100;
}

function resetPlantWithSettings() {
    initialAngleDeg = parseInt(document.getElementById('angle-slider').value);
    plantOrigin = { x: width / 2, y: height / 2 };
    frameCount = 0;
    
    // è½‰æ›è§’åº¦ç‚ºå¼§åº¦
    // 0åº¦ = å‘å³ (Canvas 0)
    // -90åº¦ = å‘ä¸Š (Canvas -PI/2)
    const rad = initialAngleDeg * (Math.PI / 180);

    // è–ï¼šæ²¿è‘—è¨­å®šè§’åº¦ç”Ÿé•·
    stemSegments = [{ 
        x: plantOrigin.x, 
        y: plantOrigin.y, 
        angle: rad, 
        width: 20, 
        length: 5, 
        type: 'stem', 
        auxinLevel: 0 
    }];

    // æ ¹ï¼šæ²¿è‘—åæ–¹å‘ç”Ÿé•·
    rootSegments = [{ 
        x: plantOrigin.x, 
        y: plantOrigin.y, 
        angle: rad + Math.PI, 
        width: 12, 
        length: 5, 
        type: 'root', 
        auxinLevel: 0 
    }];
    
    // ç¹ªè£½åœŸå£¤/ç›†æ ½åº•åº§çš„è¦–è¦ºè¼”åŠ©
    draw();
}

function togglePause() {
    isPaused = !isPaused;
}

// --- Gemini API (ä¿ç•™åŸåŠŸèƒ½) ---
function toggleAiMinimize() {
    const content = document.getElementById('ai-content-area');
    const icon = document.getElementById('minimize-icon');
    if (isAiPanelMinimized) {
        content.style.display = 'flex';
        icon.innerText = 'âˆ’';
    } else {
        content.style.display = 'none';
        icon.innerText = '+';
    }
    isAiPanelMinimized = !isAiPanelMinimized;
}

function addMessage(role, text) {
    const history = document.getElementById('chat-history');
    const msgDiv = document.createElement('div');
    if (role === 'user') {
        msgDiv.className = "bg-white text-gray-800 p-2 rounded-lg rounded-tr-none self-end ml-auto max-w-[90%] text-xs shadow-sm border border-gray-100";
        msgDiv.innerText = text;
    } else if (role === 'ai') {
        msgDiv.className = "bg-green-50 text-green-900 p-2 rounded-lg rounded-tl-none inline-block max-w-[90%] text-xs shadow-sm";
        msgDiv.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
    } else if (role === 'loading') {
        msgDiv.id = "ai-loading";
        msgDiv.className = "bg-green-50 p-2 rounded-lg rounded-tl-none inline-block w-12 text-xs";
        msgDiv.innerHTML = `<div class="flex justify-center space-x-1"><div class="w-1.5 h-1.5 bg-green-400 rounded-full typing-dot"></div><div class="w-1.5 h-1.5 bg-green-400 rounded-full typing-dot"></div><div class="w-1.5 h-1.5 bg-green-400 rounded-full typing-dot"></div></div>`;
    }
    history.appendChild(msgDiv);
    history.scrollTop = history.scrollHeight;
    return msgDiv; 
}

async function callGeminiAPI(userPrompt, systemInstruction) {
    const loadingMsg = addMessage('loading');
    try {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${apiModel}:generateContent?key=${apiKey}`;
        const payload = {
            contents: [{ parts: [{ text: userPrompt }] }],
            systemInstruction: { parts: [{ text: systemInstruction }] }
        };
        const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        const data = await response.json();
        loadingMsg.remove();
        if (data.error) { addMessage('ai', "æŠ±æ­‰ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚"); return; }
        const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text;
        addMessage('ai', aiText || "ç„¡å›æ‡‰");
    } catch (error) {
        loadingMsg.remove();
        addMessage('ai', "ç¶²è·¯é€£ç·šéŒ¯èª¤ã€‚");
    }
}

async function analyzeGrowth() {
    const stemTip = stemSegments[stemSegments.length - 1];
    const rootTip = rootSegments[rootSegments.length - 1];
    
    // è¨ˆç®—ç›®å‰è§’åº¦ (0~360)
    let stemDeg = (stemTip.angle * 180 / Math.PI) % 360;
    let rootDeg = (rootTip.angle * 180 / Math.PI) % 360;
    
    const prompt = `
    ç›®å‰æ¤ç‰©é‡åŠ›æ¨¡æ“¬å™¨ç‹€æ…‹ï¼š
    1. åˆå§‹æ“ºæ”¾è§’åº¦ï¼š${initialAngleDeg} åº¦ã€‚
    2. é‡åŠ›æ•æ„Ÿåº¦è¨­å®šï¼š${(gravityFactor * 100).toFixed(0)}%ã€‚
    3. ç›®å‰è–çš„ç”Ÿé•·è§’åº¦ï¼š${stemDeg.toFixed(1)} åº¦ã€‚
    4. ç›®å‰æ ¹çš„ç”Ÿé•·è§’åº¦ï¼š${rootDeg.toFixed(1)} åº¦ã€‚
    
    è«‹ä»¥ç”Ÿç‰©è€å¸«å£å»ï¼Œè§£é‡‹ç›®å‰çš„ç¾è±¡ï¼š
    - å¦‚æœé‡åŠ›æ•æ„Ÿåº¦ä½ï¼ˆæ¥è¿‘0ï¼‰ï¼Œç‚ºä»€éº¼æ¤ç‰©é•·å¾—ç›´ç›´çš„ï¼Ÿ
    - è§£é‡‹ã€Œå¹³è¡¡çŸ³ï¼ˆstatolithsï¼‰ã€æˆ–ã€Œæ¾±ç²‰é«”ã€å¦‚ä½•æ„ŸçŸ¥é‡åŠ›ï¼Œå°è‡´ç”Ÿé•·ç´ åˆ†ä½ˆä¸å‡ã€‚
    - ç°¡å–®èªªæ˜ç‚ºä»€éº¼æ ¹è¦å¾€ä¸‹é•·ï¼ˆç‚ºäº†æ°´å’Œé¤Šåˆ†ï¼‰ï¼Œè–è¦å¾€ä¸Šé•·ï¼ˆç‚ºäº†å…‰åˆä½œç”¨ï¼Œå³ä½¿ç¾åœ¨æ²’æœ‰å…‰ï¼ŒåŸºå› ä¹Ÿè¨­å®šå¥½äº†ï¼‰ã€‚
    `;
    const systemPrompt = "ä½ æ˜¯ä¸€ä½è¦ªåˆ‡çš„ç”Ÿç‰©è€å¸«ï¼Œæ“…é•·è§£é‡‹æ¤ç‰©ç”Ÿç†å­¸ã€‚";
    
    const btn = document.getElementById('analyze-btn');
    const originalText = btn.innerText;
    btn.disabled = true;
    btn.innerText = "âœ¨ åˆ†æä¸­...";
    addMessage('user', 'âœ¨ è«‹åˆ†æç›®å‰çš„ç”Ÿé•·ç‹€æ³èˆ‡é‡åŠ›å½±éŸ¿');
    await callGeminiAPI(prompt, systemPrompt);
    btn.disabled = false;
    btn.innerText = originalText;
}

async function askGemini() {
    const input = document.getElementById('user-input');
    const text = input.value.trim();
    if (!text) return;
    input.value = '';
    addMessage('user', text);
    const prompt = `ä½¿ç”¨è€…å•é¡Œï¼š${text}\nä¸Šä¸‹æ–‡ï¼šç›®å‰æ˜¯é‡åŠ›æ¨¡æ“¬å¯¦é©—ï¼Œåˆå§‹è§’åº¦ ${initialAngleDeg}åº¦ï¼Œé‡åŠ›ä¿‚æ•¸ ${gravityFactor}ã€‚`;
    const systemPrompt = "ä½ æ˜¯ä¸€ä½ç”Ÿç‰©è€å¸«ï¼Œå°ˆæ³¨æ–¼è§£é‡‹æ¤ç‰©å‘æ€§ã€ç”Ÿé•·ç´ èˆ‡é‡åŠ›çš„é—œä¿‚ã€‚";
    await callGeminiAPI(prompt, systemPrompt);
}

// --- ç”Ÿé•·æ¼”ç®—æ³• (Gravitropism Logic) ---

function grow() {
    if (isPaused) return;

    frameCount++;
    if (frameCount % GROWTH_SPEED !== 0) return;

    // è–é™åˆ¶é•·åº¦
    if (stemSegments.length < 350) {
        const tip = stemSegments[stemSegments.length - 1];
        growSegment(stemSegments, tip, 'stem');
    }

    // æ ¹é™åˆ¶é•·åº¦
    if (rootSegments.length < 250) {
        const tip = rootSegments[rootSegments.length - 1];
        growSegment(rootSegments, tip, 'root');
    }
}

function growSegment(segments, tip, type) {
    // ç›®æ¨™è§’åº¦ï¼š
    // è–æƒ³è¦å‚ç›´å‘ä¸Š (-PI/2)
    // æ ¹æƒ³è¦å‚ç›´å‘ä¸‹ (PI/2)
    let targetAngle = (type === 'stem') ? -Math.PI / 2 : Math.PI / 2;
    
    // è¨ˆç®—èˆ‡ç›®æ¨™çš„è§’åº¦å·®
    let angleDiff = targetAngle - tip.angle;
    
    // Normalize angle difference to -PI ~ PI
    while (angleDiff <= -Math.PI) angleDiff += Math.PI * 2;
    while (angleDiff > Math.PI) angleDiff -= Math.PI * 2;

    // è½‰å½é€Ÿåº¦å–æ±ºæ–¼ï¼š
    // 1. è§’åº¦å·® (å·®è¶Šå¤šè½‰è¶Šå¤§åŠ›)
    // 2. é‡åŠ›å› å­ (gravityFactor) - ä½¿ç”¨è€…è¨­å®š
    // 3. åŸºç¤ç”Ÿé•·åƒæ•¸
    
    // é€™è£¡åŠ å…¥ä¸€å€‹ç‰©ç†ç´°ç¯€ï¼šæ¤ç‰©å¦‚æœå·²ç¶“å‚ç›´äº†ï¼Œå—é‡åŠ›å´å‘åˆ†é‡æœ€å°ï¼Œå½æ›²åŠ›æœ€å°
    // æˆ‘å€‘å¯ä»¥ç”¨ cos(angle) ä¾†ä»£è¡¨ã€Œå—é‡åŠ›å½±éŸ¿çš„ç¨‹åº¦ã€(æ°´å¹³æ™‚æœ€å¤§)
    // ä½†ç°¡å–®èµ·è¦‹ï¼Œç›´æ¥ç”¨è§’åº¦å·®ä¾†é©…å‹•å³å¯
    
    let turnRate = 0.15; // åŸºç¤è½‰å‘èƒ½åŠ›
    
    // è¨ˆç®—ç”Ÿé•·ç´ åˆ†ä½ˆå°è‡´çš„å½æ›²
    // ç•¶ gravityFactor = 0 (å¤ªç©º)ï¼ŒdeltaAngle æ‡‰è©²è¦æ˜¯ 0ï¼Œæ¤ç‰©ç›´ç›´é•·
    let deltaAngle = angleDiff * turnRate * gravityFactor;

    // é™åˆ¶å–®æ¬¡æœ€å¤§å½æ›²ï¼Œé¿å…æ‰“çµ
    const maxBend = 0.1; 
    if (deltaAngle > maxBend) deltaAngle = maxBend;
    if (deltaAngle < -maxBend) deltaAngle = -maxBend;

    const newAngle = tip.angle + deltaAngle;
    const newWidth = Math.max(2, tip.width * 0.995); // è¶Šé•·è¶Šç´°
    const length = 4;
    
    const newX = tip.x + Math.cos(newAngle) * length;
    const newY = tip.y + Math.sin(newAngle) * length;

    // --- è¨ˆç®—ç”Ÿé•·ç´ æ²‰é™ç‹€æ…‹ (Auxin Sedimentation) ---
    // é€™æ±ºå®šäº†è¦–è¦ºä¸Šç´…/è—é»é»ç•«åœ¨å“ªä¸€é‚Š
    // æˆ‘å€‘éœ€è¦çŸ¥é“å“ªä¸€é‚Šæ˜¯ã€Œä¸‹æ–¹ã€
    
    // æ³•å‘é‡è¨ˆç®—ï¼š
    // ç›®å‰ç”Ÿé•·æ–¹å‘æ˜¯ angle
    // ã€Œå³å´ã€æ³•å‘é‡æ˜¯ angle + PI/2
    // å¦‚æœå³å´æ³•å‘é‡çš„ Y åˆ†é‡ > 0 (æœä¸‹)ï¼Œä»£è¡¨å³å´æ˜¯ä¸‹æ–¹
    
    const rightNormalAngle = newAngle + Math.PI / 2;
    const isRightSideDown = Math.sin(rightNormalAngle) > 0;
    
    // è¨ˆç®—ã€Œæ°´å¹³ç¨‹åº¦ã€ï¼Œè¶Šæ°´å¹³ï¼Œæ²‰é™è¶Šæ˜é¡¯
    const horizontalness = Math.abs(Math.cos(newAngle));
    
    // auxinLevel: 0=å‡è¡¡, 1=å³å´å¤š(ä¸‹æ–¹), -1=å·¦å´å¤š(ä¸‹æ–¹)
    // åªæœ‰åœ¨é‡åŠ›ä¿‚æ•¸å¤ å¤§ä¸”æœ‰æ°´å¹³åˆ†é‡æ™‚æ‰é¡¯ç¤ºæ²‰é™
    let auxinState = 0;
    
    if (gravityFactor > 0.1 && horizontalness > 0.1) {
        auxinState = isRightSideDown ? 1 : -1;
    }

    segments.push({
        x: newX,
        y: newY,
        angle: newAngle,
        width: newWidth,
        auxinLevel: auxinState, // 1: Right/Bottom side high, -1: Left/Bottom side high
        horizontalIntensity: horizontalness * gravityFactor, // ç”¨æ–¼æ§åˆ¶ç²’å­å¯†åº¦
        type: type
    });
}

// --- ç¹ªåœ–é‚è¼¯ ---

function draw() {
    ctx.clearRect(0, 0, width, height);

    // èƒŒæ™¯
    // ç•«ä¸€å€‹å¤§åœ“ä»£è¡¨é‡åŠ›å ´çš„ç¤ºæ„ï¼Œæˆ–è€…å–®ç´”èƒŒæ™¯
    
    // ç•«ç›†æ ½/ç¨®å­ä½ç½®çš„æ—‹è½‰åº•åº§
    ctx.save();
    ctx.translate(plantOrigin.x, plantOrigin.y);
    ctx.rotate(initialAngleDeg * Math.PI / 180); // æ—‹è½‰æ•´å€‹ç›†æ ½
    
    // ç›†æ ½
    ctx.fillStyle = "#8d6e63"; // åœŸå£¤è‰²
    ctx.fillRect(-20, -20, 40, 40); 
    ctx.strokeStyle = "#5d4037";
    ctx.lineWidth = 2;
    ctx.strokeRect(-20, -20, 40, 40);
    
    // ç›†æ ½é‚Šç·£
    ctx.beginPath();
    ctx.moveTo(-25, -25);
    ctx.lineTo(-20, 25);
    ctx.lineTo(20, 25);
    ctx.lineTo(25, -25);
    ctx.strokeStyle = "#795548";
    ctx.stroke();
    
    ctx.restore();

    // ç•«æ¤ç‰©
    drawPlantPart(rootSegments, "#8d6e63"); // æ ¹ï¼šæ·±è¤è‰²
    drawPlantPart(stemSegments, "#4caf50"); // è–ï¼šç¶ è‰²
    
    // ç•«ä¸­å¿ƒç¨®å­
    ctx.beginPath();
    ctx.arc(plantOrigin.x, plantOrigin.y, 8, 0, Math.PI * 2);
    ctx.fillStyle = "#d7ccc8";
    ctx.fill();
    ctx.stroke();

    // ç•«é‡åŠ›ç®­é ­ç¤ºæ„
    drawGravityIndicator();
}

function drawGravityIndicator() {
    if (gravityFactor < 0.1) return; // ç„¡é‡åŠ›ä¸ç•«

    const x = width - 50;
    const y = 100;
    const size = 30 * gravityFactor;
    
    ctx.fillStyle = "rgba(0,0,0,0.2)";
    ctx.font = "12px sans-serif";
    ctx.fillText("Gravity (g)", x - 25, y - 40);
    
    ctx.strokeStyle = "rgba(0,0,0,0.3)";
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(x, y - size);
    ctx.lineTo(x, y + size);
    ctx.lineTo(x - 5, y + size - 5);
    ctx.moveTo(x, y + size);
    ctx.lineTo(x + 5, y + size - 5);
    ctx.stroke();
}

function drawPlantPart(segments, colorMain) {
    if (segments.length < 2) return;
    ctx.lineCap = "round";
    ctx.lineJoin = "round";

    for (let i = 0; i < segments.length; i++) {
        const seg = segments[i];
        
        ctx.fillStyle = colorMain;
        ctx.beginPath();
        ctx.arc(seg.x, seg.y, seg.width / 2, 0, Math.PI * 2);
        ctx.fill();

        // è¦–è¦ºåŒ–ç”Ÿé•·ç´  (Auxin)
        // æ¢ä»¶ï¼šå¿…é ˆä¸æ˜¯å¤ªèˆŠçš„ç´°èƒ (i > length - 50)ï¼Œä¸”æœ‰é‡åŠ›èˆ‡æ°´å¹³åˆ†é‡
        // ç”Ÿé•·ç´ æœƒæ²‰ç©åœ¨ã€Œä¸‹æ–¹ã€
        
        const isActiveZone = i > segments.length - 60; // åªåœ¨ç”Ÿé•·ç«¯é¡¯ç¤ºæ˜é¡¯
        
        if (isActiveZone && seg.horizontalIntensity > 0.1) {
            let leftCount = 0;
            let rightCount = 0;
            
            // åŸºç¤ç²’å­æ•¸
            const density = Math.floor(seg.horizontalIntensity * 5) + 1;
            
            if (seg.auxinLevel === 1) { // å³å´æ˜¯ä¸‹æ–¹
                rightCount = density + 2;
                leftCount = 0;
            } else if (seg.auxinLevel === -1) { // å·¦å´æ˜¯ä¸‹æ–¹
                leftCount = density + 2;
                rightCount = 0;
            }
            
            const seed = i * 4321;
            drawAuxinParticles(seg, leftCount, 'left', seed, seg.type);
            drawAuxinParticles(seg, rightCount, 'right', seed, seg.type);
        }
    }
}

function drawAuxinParticles(seg, count, side, seed, type) {
    if (count <= 0) return;
    
    const perpAngle = seg.angle - Math.PI / 2;
    const baseAngle = (side === 'left') ? perpAngle : perpAngle + Math.PI;
    
    // é¡è‰²å®šç¾©
    // è–ï¼šç´…è‰² (ç”Ÿé•·ç´ å¤š = é•·å¾—å¿«)
    // æ ¹ï¼šè—è‰² (ç”Ÿé•·ç´ å¤š = é•·å¾—æ…¢)
    ctx.fillStyle = (type === 'root') ? "rgba(37, 99, 235, 0.8)" : "rgba(220, 38, 38, 0.8)";

    for (let k = 0; k < count; k++) {
        // éš¨æ©Ÿåˆ†ä½ˆåœ¨è©²å´é‚Šç·£é™„è¿‘
        const rnd1 = Math.abs(Math.sin(seed + k * 12.34)); // 0~1
        const rnd2 = Math.abs(Math.cos(seed + k * 56.78)); // 0~1
        
        // ä½ç½®åç§»ï¼šåå‘å¤–å´ (0.4 ~ 0.9 åŠå¾‘è™•)
        const dist = (seg.width / 2) * (0.4 + rnd1 * 0.5);
        
        // è§’åº¦åç§»ï¼šé›†ä¸­åœ¨è©²å´ä¸­å¿ƒ
        const angleOffset = (rnd2 - 0.5) * 1.5; 
        
        const pAngle = baseAngle + angleOffset;
        const px = seg.x + Math.cos(pAngle) * dist;
        const py = seg.y + Math.sin(pAngle) * dist;

        ctx.beginPath();
        ctx.arc(px, py, 1.5, 0, Math.PI * 2); // ç²’å­å¤§å°
        ctx.fill();
    }
}

function loop() {
    grow();
    draw();
    animationId = requestAnimationFrame(loop);
}

// å•Ÿå‹•
init();

</script>
</body>
</html>