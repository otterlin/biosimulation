<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>心臟構造拖曳測驗</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 載入 html2canvas 庫用於截圖下載 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            overflow: hidden;
        }

        .label {
            touch-action: none;
            cursor: grab;
            transition: all 0.2s ease-in-out;
            min-width: 90px;
            text-align: center;
            user-select: none;
        }

        .label.dragging {
            opacity: 0.5;
            cursor: grabbing;
            transform: scale(1.05);
        }

        .drop-zone {
            min-height: 40px;
            border: 2px dashed #9ca3af;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 0.375rem;
            transition: all 0.2s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2px;
            width: 100%;
        }
        
        .drop-zone.hovered {
            background-color: rgba(74, 222, 128, 0.3);
            border-color: #22c55e;
        }

        .drop-zone.correct {
            background-color: rgba(34, 197, 94, 0.7);
            border: 2px solid #16a34a;
        }

        .drop-zone.incorrect {
            background-color: rgba(239, 68, 68, 0.7);
            border: 2px solid #dc2626;
        }
        
        .drop-zone .label {
            transform: scale(0.95);
            flex-shrink: 0;
            white-space: nowrap;
        }

        .number-marker {
            position: absolute;
            width: 30px;
            height: 30px;
            background-color: rgba(255, 255, 0, 0.9);
            color: #000;
            border: 2px solid #000;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.95rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            z-index: 10;
        }

        @media (max-width: 768px) {
            .number-marker {
                width: 25px;
                height: 25px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col h-screen">

    <header class="bg-white shadow-md p-4 flex-shrink-0" id="capture-header">
        <h1 class="text-2xl font-bold text-center text-blue-700 mb-4">心臟構造拖曳測驗</h1>
        <div id="student-info" class="flex flex-wrap justify-center gap-4 items-center">
            <div>
                <label class="font-medium">班級：</label>
                <input type="text" id="class-num" class="border rounded-md p-2 w-24">
            </div>
            <div>
                <label class="font-medium">座號：</label>
                <input type="text" id="seat-num" class="border rounded-md p-2 w-16">
            </div>
            <div>
                <label class="font-medium">姓名：</label>
                <input type="text" id="name" class="border rounded-md p-2 w-32">
            </div>
        </div>
    </header>

    <main id="capture-main" class="flex-1 flex flex-col md:flex-row p-4 gap-4 overflow-hidden">
        <!-- 心臟圖區域 -->
        <div class="flex flex-col items-center justify-center bg-white shadow-lg rounded-lg p-4 md:w-3/5 md:h-full overflow-auto flex-shrink-0">
            <div id="image-container" class="relative max-w-full max-h-full">
                <img src="https://otterlin.github.io/biosimulation/heart.png" 
                     alt="心臟構造圖" 
                     class="object-contain"
                     crossorigin="anonymous"
                     style="max-width: 100%; max-height: 450px;">
                
                <!-- 數字標記位置（已移除 9） -->
                <div class="number-marker" style="top: 15%; left: 21%;">1</div>
                <div class="number-marker" style="top: 14%; left: 44%;">2</div>
                <div class="number-marker" style="top: 25%; left: 35%;">3</div>
                <div class="number-marker" style="top: 35%; left: 68%;">4</div>
                <div class="number-marker" style="top: 46%; left: 61%;">5</div>
                <div class="number-marker" style="top: 70%; left: 58%;">6</div>
                <div class="number-marker" style="top: 40%; left: 28%;">7</div>
                <div class="number-marker" style="top: 70%; left: 35%;">8</div>
            </div>
        </div>

        <!-- 標籤與答案區域 -->
        <div class="w-full md:w-2/5 flex flex-col gap-4 overflow-hidden">
            <div id="label-bank" class="bg-white shadow-lg rounded-lg p-4 flex flex-wrap gap-3 content-start overflow-y-auto flex-shrink-0" style="max-height: 30%;">
                <h2 class="w-full text-lg font-semibold mb-2">待選標籤</h2>
                <div id="label-la" draggable="true" class="label bg-blue-500 text-white py-2 px-3 rounded-lg shadow">左心房</div>
                <div id="label-ra" draggable="true" class="label bg-blue-500 text-white py-2 px-3 rounded-lg shadow">右心房</div>
                <div id="label-lv" draggable="true" class="label bg-blue-500 text-white py-2 px-3 rounded-lg shadow">左心室</div>
                <div id="label-rv" draggable="true" class="label bg-blue-500 text-white py-2 px-3 rounded-lg shadow">右心室</div>
                <div id="label-pa" draggable="true" class="label bg-red-500 text-white py-2 px-3 rounded-lg shadow">肺動脈</div>
                <div id="label-pv" draggable="true" class="label bg-pink-500 text-white py-2 px-3 rounded-lg shadow">肺靜脈</div>
                <div id="label-aorta" draggable="true" class="label bg-red-500 text-white py-2 px-3 rounded-lg shadow">主動脈</div>
                <div id="label-venacavae" draggable="true" class="label bg-blue-500 text-white py-2 px-3 rounded-lg shadow">上下大靜脈</div>
                <!-- 瓣膜標籤已移除 -->
            </div>

            <div id="answer-area" class="bg-white shadow-lg rounded-lg p-4 overflow-y-auto flex-grow">
                <h2 class="w-full text-lg font-semibold mb-3">作答區 (對應號碼)</h2>
                <div class="grid grid-cols-1 gap-3">
                    <template id="zone-template">
                        <div class="flex items-center gap-3">
                            <span class="font-bold text-lg w-6 zone-num"></span>
                            <div class="drop-zone flex-1"></div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-white shadow-inner p-4 flex-shrink-0 flex flex-wrap justify-center items-center gap-4" id="capture-footer">
        <button id="submit-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg shadow transition-transform transform hover:scale-105">
            提交答案
        </button>
        <button id="reset-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-6 rounded-lg shadow transition-transform transform hover:scale-105">
            重新開始
        </button>
        <button id="download-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow transition-transform transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
            下載成績截圖
        </button>
        <div id="score-display" class="text-lg font-semibold text-blue-800 p-2 rounded-md bg-blue-100 min-h-[50px] min-w-[200px] text-center">
            請開始作答...
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const labelBank = document.getElementById('label-bank');
            const answerArea = document.querySelector('#answer-area .grid');
            const template = document.getElementById('zone-template');
            const scoreDisplay = document.getElementById('score-display');
            const downloadBtn = document.getElementById('download-btn');
            
            // 已更新：正確答案清單移除 9
            const correctAnswers = {
                'zone-1': 'label-venacavae',
                'zone-2': 'label-pa',
                'zone-3': 'label-aorta',
                'zone-4': 'label-pv',
                'zone-5': 'label-la',
                'zone-6': 'label-lv',
                'zone-7': 'label-ra',
                'zone-8': 'label-rv'
            };

            // 動態產生 8 個作答區
            for (let i = 1; i <= 8; i++) {
                const clone = template.content.cloneNode(true);
                clone.querySelector('.zone-num').textContent = `${i}.`;
                clone.querySelector('.drop-zone').id = `zone-${i}`;
                answerArea.appendChild(clone);
            }

            const labels = document.querySelectorAll('.label');
            const dropZones = document.querySelectorAll('.drop-zone');
            let draggedLabel = null;

            labels.forEach(label => {
                label.addEventListener('dragstart', (e) => {
                    draggedLabel = e.target;
                    e.dataTransfer.setData('text/plain', e.target.id);
                    e.target.classList.add('dragging');
                });
                label.addEventListener('dragend', () => {
                    label.classList.remove('dragging');
                    draggedLabel = null;
                });
            });

            const dropTargets = [...dropZones, labelBank];
            dropTargets.forEach(target => {
                target.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    target.classList.add('hovered');
                });
                target.addEventListener('dragleave', () => target.classList.remove('hovered'));
                target.addEventListener('drop', (e) => {
                    e.preventDefault();
                    target.classList.remove('hovered');
                    const id = e.dataTransfer.getData('text/plain') || (draggedLabel ? draggedLabel.id : null);
                    if (!id) return;

                    const draggableElement = document.getElementById(id);
                    const existingLabel = target.querySelector('.label');

                    if (target.classList.contains('drop-zone')) {
                        if (existingLabel) labelBank.appendChild(existingLabel);
                        target.appendChild(draggableElement);
                    } else if (target.id === 'label-bank') {
                        target.appendChild(draggableElement);
                    }
                });
            });

            document.getElementById('submit-btn').addEventListener('click', () => {
                let score = 0;
                const studentName = document.getElementById('name').value || '匿名同學';
                const className = document.getElementById('class-num').value || 'N/A';
                const seatNumber = document.getElementById('seat-num').value || 'N/A';

                dropZones.forEach(zone => {
                    zone.classList.remove('correct', 'incorrect');
                    const droppedLabel = zone.querySelector('.label');
                    if (droppedLabel && droppedLabel.id === correctAnswers[zone.id]) {
                        score++;
                        zone.classList.add('correct');
                    } else {
                        zone.classList.add('incorrect');
                    }
                });

                scoreDisplay.innerHTML = `${className} 班 ${seatNumber} 號 ${studentName}<br><span class="text-2xl font-bold">得分: ${score} / 8</span>`;
                labels.forEach(l => l.setAttribute('draggable', 'false'));
                downloadBtn.disabled = false;
            });

            document.getElementById('reset-btn').addEventListener('click', () => {
                dropZones.forEach(zone => {
                    const label = zone.querySelector('.label');
                    if (label) labelBank.appendChild(label);
                    zone.classList.remove('correct', 'incorrect');
                });
                scoreDisplay.textContent = '請開始作答...';
                labels.forEach(l => l.setAttribute('draggable', 'true'));
                downloadBtn.disabled = true;
            });

            downloadBtn.addEventListener('click', async () => {
                const studentName = document.getElementById('name').value || '同學';
                const originalText = scoreDisplay.innerHTML;
                scoreDisplay.textContent = '截圖處理中...';
                
                try {
                    const canvas = await html2canvas(document.body, {
                        useCORS: true,
                        scale: 2
                    });
                    const link = document.createElement('a');
                    link.download = `心臟測驗成績_${studentName}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                } catch (err) {
                    console.error('Screenshot failed', err);
                } finally {
                    scoreDisplay.innerHTML = originalText;
                }
            });
        });
    </script>
</body>
</html>